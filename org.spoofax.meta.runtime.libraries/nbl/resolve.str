module nbl/resolve

imports
  
  nbl/tasks
	nbl/entries
	task/core
      
rules // Reference resolution
  
  nabl-is-reference =
    ?Use(_)
    
  nabl-has-reference =
    collect-one(nabl-is-reference)
    
  nabl-has-reference =
    has-annos;
    get-annos;
    nabl-has-reference
  
  // TODO: does not go through annotations?
	nabl-collect-all-resolved-defs:
		ast -> def*
		with
			if ast' := <insert-results> ast then
				def* := <collect-all(?Def(_))> ast'
			else
				def* := []
			end

	nabl-collect-one-resolved-def =
		insert-results-or-create-dependency;
		oncetd-annos((?Def(_) <+ ?Dependency(_)); ?d); !d
		
	nabl-collect-one-resolved-def-fail =
		insert-results;
		oncetd-annos(?Def(_); ?d); !d
		
	oncetd-annos(s) = s <+ has-annos; get-annos; one(oncetd-annos(s)) <+ one(oncetd-annos(s))
	